{% extends "base.html" %}

{% block title %}{{ member.name }} - Gym Manager{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <a href="{{ url_for('dashboard') }}" style="color: var(--text-muted); text-decoration: none;">&larr; Back to
            Dashboard</a>
    </div>

    <!-- Member Profile Card -->
    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; gap: 2rem; align-items: start; flex-wrap: wrap;">
            <!-- Photo -->
            <div style="flex-shrink: 0;">
                {% if member.photo %}
                <img src="{{ url_for('static', filename='uploads/' + member.photo) }}"
                    style="width: 150px; height: 150px; border-radius: 12px; object-fit: cover;"
                    alt="{{ member.name }}">
                {% else %}
                <div
                    style="width: 150px; height: 150px; border-radius: 12px; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-size: 4rem; font-weight: 700; color: white; box-shadow: 0 10px 20px hsla(260, 80%, 60%, 0.3);">
                    {{ member.name[0] }}
                </div>
                {% endif %}
            </div>

            <!-- Details -->
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <h1 style="margin: 0;">{{ member.name }}</h1>
                    <span class="badge" style="background: var(--bg); border: 1px solid var(--border);">{{
                        member.membership_type or 'Gym' }}</span>
                </div>

                <p style="color: var(--text-muted); margin-top: 0.5rem;">ID: {{ member.id }}</p>

                <div style="margin-top: 1.5rem; display: grid; gap: 0.5rem;">
                    <div><strong>ğŸ“± Phone:</strong> {{ member.phone }}</div>
                    <div><strong>ğŸ“… Joined:</strong> {{ member.joined_date }}</div>
                    <div style="font-size: 1.1rem; color: var(--success); margin-top: 0.5rem;">
                        <strong>ğŸ’° Total Paid:</strong> ${{ history|sum(attribute='amount') }}
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <a href="https://wa.me/{{ member.phone|replace(' ', '')|replace('-', '') }}?text=Hello {{ member.name }}"
                        target="_blank" class="btn" style="background-color: #25D366; color: white;">ğŸ’¬ WhatsApp</a>
                    <a href="sms:{{ member.phone|replace(' ', '')|replace('-', '') }}?body=Hello {{ member.name }}"
                        class="btn" style="background-color: #f39c12; color: white;">ğŸ’¬ SMS</a>
                    {% if member.email %}
                    <a href="mailto:{{ member.email }}" class="btn" style="background-color: #3498db; color: white;">âœ‰ï¸
                        Email</a>
                    {% endif %}
                    <a href="{{ url_for('edit_member', member_id=member.id) }}" class="btn btn-secondary">âœï¸ Edit</a>
                    <a href="{{ url_for('generate_card', member_id=member.id) }}" class="btn btn-secondary">ğŸ“„ Card</a>
                    <form method="POST" action="{{ url_for('delete_member', member_id=member.id) }}"
                        style="display: inline;"
                        onsubmit="return confirm('Are you sure you want to delete this member? This cannot be undone.');">
                        <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Actions -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>ğŸ’° Record Payment</h3>
        <form method="POST" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end; margin-top: 1rem;">
            <div style="flex: 1; min-width: 200px;">
                <label for="month">Billing Month</label>
                <input type="month" id="month" name="month" required value="{{ current_month }}"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="payment_date">Payment Date</label>
                <input type="date" id="payment_date" name="payment_date" value="{{ today }}"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="amount">Amount</label>
                <input type="number" id="amount" name="amount" required placeholder="Enter amount" min="0" step="0.01">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="notes">Notes</label>
                <input type="text" id="notes" name="notes" placeholder="e.g. Cash, Online..."
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
            </div>

            <button type="submit" class="btn btn-success" style="height: 46px;">âœ… Pay Now</button>
        </form>
    </div>

    <!-- Fee History -->
    <div class="card">
        <h3>ğŸ“œ Payment History</h3>
        {% if history %}
        <table style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Amount</th>
                    <th>Date Paid</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for fee in history %}
                <tr>
                    <td>{{ fee.month }}</td>
                    <td>${{ fee.amount }}</td>
                    <td>{{ fee.paid_date }}</td>
                    <td><span style="font-size: 0.9rem; color: var(--text-muted);">{{ fee.notes or '-' }}</span></td>
                    <td>
                        <a href="{{ url_for('generate_receipt', member_id=member.id, month=fee.month) }}"
                            class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                            ğŸ“„ Receive
                        </a>
                        <a href="{{ url_for('edit_fee_record', member_id=member.id, month=fee.month) }}"
                            class="btn btn-secondary"
                            style="padding: 0.25rem 0.4rem; font-size: 0.8rem; margin-left: 0.5rem; background-color: #f39c12; border-color: #f39c12; color: white;">
                            âœï¸
                        </a>
                        <form action="{{ url_for('delete_fee_record', member_id=member.id, month=fee.month) }}"
                            method="POST" style="display:inline;"
                            onsubmit="return confirm('Delete payment for {{ fee.month }}?');">
                            <button type="submit" class="btn btn-danger"
                                style="padding: 0.25rem 0.4rem; font-size: 0.8rem; margin-left: 0.5rem;">
                                ğŸ—‘ï¸
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; padding: 2rem; color: var(--text-muted);">No payment history found.</p>
        {% endif %}
    </div>
</div>
{% endblock %}